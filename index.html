<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing-Playground 打字遊樂場</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff; /* bg-sky-50 */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .game-wrapper {
            width: 100%;
            max-width: 600px;
            height: 85vh;
            max-height: 800px;
            background-color: #ffffff; /* bg-white */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        /* --- 主選單樣式 --- */
        #main-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; padding: 2rem; }
        #main-menu h1 { font-family: 'Poppins', 'Noto Sans TC', sans-serif; font-size: 3.5rem; color: #0c4a6e; margin-bottom: 0.5rem; }
        #main-menu p { font-size: 1.25rem; color: #38bdf8; margin-bottom: 3rem; }
        .menu-button { padding: 1rem 2rem; font-size: 1.25rem; font-weight: 700; color: white; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; width: 80%; margin-bottom: 1.5rem; }
        .menu-button:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        #btn-game-static { background-color: #34d399; box-shadow: 0 4px #10b981; }
        #btn-game-dash { background-color: #f43f5e; box-shadow: 0 4px #be123c; }
        #btn-game-monster { background-color: #a78bfa; box-shadow: 0 4px #8b5cf6; }
        
        .back-button { position: absolute; top: 1rem; left: 1rem; padding: 0.5rem 1rem; font-size: 1rem; font-weight: 700; color: #475569; background-color: #f1f5f9; border-radius: 8px; cursor: pointer; z-index: 50; transition: all 0.2s ease; }
        .back-button:hover { background-color: #e2e8f0; }
        
        /* 新增：語音按鈕樣式 */
        .mic-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            background-color: transparent;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: all 0.2s ease;
        }
        .mic-button:hover { background-color: #f1f5f9; }
        .mic-button.listening { color: #ef4444; animation: pulse-mic 1.5s infinite; }
        @keyframes pulse-mic { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { transform: scale(1.1); box-shadow: 0 0 5px 10px rgba(239, 68, 68, 0); } }


        .hidden { display: none !important; }

        /* --- 靜態練習遊戲樣式 --- */
        #game-static { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background-color: #f0f9ff; }
        #gs-char-display { font-family: 'Fredoka One', cursive; text-align: center; font-size: 5rem; color: #334155; min-height: 100px; padding: 1rem; background: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; width: 90%; letter-spacing: 0.1em; }
        #gs-char-display span { display: inline-block; transition: color 0.2s; }
        .gs-correct { color: #10B981; }
        @keyframes gs-shake-correct { 0%,100%{transform:translate(0,0)}10%{transform:translate(-5px,-8px)}20%{transform:translate(8px,5px)}30%{transform:translate(5px,-8px)}40%{transform:translate(-8px,-5px)}50%{transform:translate(-5px,8px)}60%{transform:translate(8px,5px)}70%{transform:translate(5px,8px)}80%{transform:translate(-8px,-5px)}90%{transform:translate(-5px,5px)} }
        @keyframes gs-shake-incorrect { 0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-10px)}40%,80%{transform:translateX(10px)} }
        .gs-shake-correct-animation { animation: gs-shake-correct 0.6s ease-in-out; }
        .gs-shake-incorrect-animation { animation: gs-shake-incorrect 0.4s ease-in-out; }
        @keyframes pulse-ready { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.98); } }
        .pulse-animation { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; font-size: 3rem; color: #0c4a6e; animation: pulse-ready 1.5s ease-in-out infinite; }

        /* --- 打字衝刺遊戲樣式 --- */
        #game-dash { height: 100%; background-color: #0f172a; display: flex; flex-direction: column; }
        #gd-ui-bar { padding: 0.5rem 1rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.8rem; md:font-size: 1rem; font-weight: 700; color: #f1f5f9; background-color: rgba(15, 23, 42, 0.5); border-bottom: 2px solid #334155; z-index: 10; text-align: center; }
        #gd-game-area { flex-grow: 1; position: relative; }
        #gd-game-area .letter { position: absolute; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.8rem; color: #f1f5f9; background-color: #f43f5e; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.4); transition: transform 0.1s ease-out; }
        #gd-game-area .popped { transform: scale(1.5); opacity: 0; transition: all 0.2s ease-out; }
        .gd-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 20; padding: 2rem; color: #f1f5f9; }
        .gd-overlay h1 { font-family: 'Poppins', sans-serif; font-size: 3rem; margin-bottom: 1rem; color: #f43f5e; }
        .gd-overlay .button { padding: 0.8rem 1.8rem; font-size: 1rem; font-weight: 700; color: #f1f5f9; background-color: #f43f5e; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px #be123c; }
        
        /* --- 打怪物遊戲樣式 --- */
        #game-monster { height: 100%; background-color: #334155; display: flex; flex-direction: column; }
        #gm-ui-bar { padding: 0.5rem 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 1rem; font-weight: 700; color: #f1f5f9; background-color: rgba(30, 41, 59, 0.5); border-bottom: 2px solid #475569; z-index: 10; text-align: center; }
        #gm-game-area { flex-grow: 1; position: relative; }
        .monster, .boss-part { position: absolute; transition: width 0.3s ease-out, height 0.3s ease-out, opacity 0.3s ease-out, transform 0.3s ease-out; display: flex; align-items: center; justify-content: center; }
        .monster-graphic { font-size: 5rem; line-height: 1; transition: font-size 0.3s ease-out; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .monster-char { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Poppins', sans-serif; font-size: 2rem; color: white; font-weight: 700; -webkit-text-stroke: 1.5px #334155; }
        .boss-part .monster-char { font-size: 1.5rem; }
        @keyframes tentacle-wiggle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .tentacle { animation: tentacle-wiggle 2s ease-in-out infinite; }
        @keyframes weak-point-glow { 0%, 100% { filter: drop-shadow(0 0 10px #fef08a); } 50% { filter: drop-shadow(0 0 20px #fde047); } }
        .weak-point .monster-graphic { animation: weak-point-glow 1.5s ease-in-out infinite; }
        .monster-hit { animation: monster-shake 0.3s ease-in-out; }
        @keyframes monster-shake { 0%,100%{transform:translateX(0)}10%,50%{transform:translateX(-8px)}30%,70%{transform:translateX(8px)} }
        .monster-explode { transform: scale(2.5) rotate(45deg) !important; opacity: 0 !important; }

        @keyframes screen-shake { 0%{transform:translate(1px,1px) rotate(0deg)}10%{transform:translate(-1px,-2px) rotate(-1deg)}20%{transform:translate(-3px,0px) rotate(1deg)}30%{transform:translate(3px,2px) rotate(0deg)}40%{transform:translate(1px,-1px) rotate(1deg)}50%{transform:translate(-1px,2px) rotate(-1deg)}100%{transform:translate(0,0) rotate(0deg)} }
        .screen-shake-animation { animation: screen-shake 0.4s; }
    </style>
</head>
<body>

    <div class="game-wrapper">

        <!-- ===== 主選單畫面 ===== -->
        <div id="main-menu">
            <h1>Typing Playground</h1>
            <p>選擇一個遊戲來挑戰吧！</p>
            <button id="btn-game-static" class="menu-button">靜態練習</button>
            <button id="btn-game-dash" class="menu-button">打字衝刺</button>
            <button id="btn-game-monster" class="menu-button">打怪物</button>
        </div>

        <!-- ===== 遊戲一：靜態練習 ===== -->
        <div id="game-static" class="hidden">
            <button class="back-button">返回選單</button>
            <button class="mic-button" id="gs-mic-button" title="語音輸入">🎤</button>
            <div class="text-2xl text-slate-600 mb-6 font-bold">請依序打出下面的單字</div>
            <div id="gs-char-display">點擊或按任意鍵開始</div>
            <div id="gs-message" class="mt-6 h-10 text-xl text-slate-500"></div>
        </div>

        <!-- ===== 遊戲二：打字衝刺 ===== -->
        <div id="game-dash" class="hidden">
            <button class="back-button">返回選單</button>
            <button class="mic-button" id="gd-mic-button" title="語音輸入">🎤</button>
            <div id="gd-ui-bar">
                <span>關卡: <span id="gd-level-display">1</span></span>
                <span>生命: <span id="gd-lives-display">5</span></span>
                <span>分數: <span id="gd-score-display">0</span></span>
                <span>下關還差: <span id="gd-countdown-display">10</span></span>
            </div>
            <div id="gd-game-area"></div>
            <div id="gd-game-over-screen" class="gd-overlay hidden">
                <h1>遊戲結束</h1>
                <p>你的最終分數是: <span id="gd-final-score">0</span></p>
                <button id="gd-restart-button" class="button">重新挑戰</button>
            </div>
        </div>

        <!-- ===== 遊戲三：打怪物 ===== -->
        <div id="game-monster" class="hidden">
            <button class="back-button">返回選單</button>
            <button class="mic-button" id="gm-mic-button" title="語音輸入">🎤</button>
            <div id="gm-ui-bar">
                <span>關卡: <span id="gm-level-display">1</span></span>
                <span>已擊敗: <span id="gm-defeated-display">0</span></span>
            </div>
            <div id="gm-game-area"></div>
            <div id="gm-game-over-screen" class="gd-overlay hidden" style="background-color: rgba(51, 65, 85, 0.8);">
                <h1>遊戲結束</h1>
                <p>你存活到了第 <span id="gm-final-level">1</span> 關！</p>
                <button id="gm-restart-button" class="button" style="background-color: #a78bfa; box-shadow: 0 4px #8b5cf6;">重新挑戰</button>
            </div>
        </div>

    </div>

    <script>
        // --- 全域元素, 事件監聽, 畫面切換邏輯 ---
        const gameWrapper = document.querySelector('.game-wrapper');
        const mainMenu = document.getElementById('main-menu');
        const gameStaticContainer = document.getElementById('game-static');
        const gameDashContainer = document.getElementById('game-dash');
        const gameMonsterContainer = document.getElementById('game-monster');
        document.getElementById('btn-game-static').addEventListener('click', () => showGame('static'));
        document.getElementById('btn-game-dash').addEventListener('click', () => showGame('dash'));
        document.getElementById('btn-game-monster').addEventListener('click', () => showGame('monster'));
        document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', showMenu));
        let activeGameKey = null;
        function showMenu() { if (activeGameKey && games[activeGameKey]) { games[activeGameKey].end(); } activeGameKey = null; mainMenu.classList.remove('hidden'); gameStaticContainer.classList.add('hidden'); gameDashContainer.classList.add('hidden'); gameMonsterContainer.classList.add('hidden'); }
        function showGame(gameName) { mainMenu.classList.add('hidden'); activeGameKey = gameName; const container = document.getElementById(`game-${gameName}`); container.classList.remove('hidden'); if (games[activeGameKey]) { games[activeGameKey].start(); } }

        // ===================================
        // ===== 語音辨識核心 (gameVoice) =====
        // ===================================
        const gameVoice = {
            recognition: null,
            isSupported: ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window),
            isListening: false,
            charMap: { 'A': 'A', 'B': 'B', 'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'H': 'H', 'I': 'I', 'J': 'J', 'K': 'K', 'L': 'L', 'M': 'M', 'N': 'N', 'O': 'O', 'P': 'P', 'Q': 'Q', 'R': 'R', 'S': 'S', 'T': 'T', 'U': 'U', 'V': 'V', 'W': 'W', 'X': 'X', 'Y': 'Y', 'Z': 'Z', 'BEE': 'B', 'CEE': 'C', 'DEE': 'D', 'EFF': 'F', 'GEE': 'G', 'AITCH': 'H', 'JAY': 'J', 'KAY': 'K', 'ARR': 'R', 'ESS': 'S', 'TEE': 'T', 'YOU': 'U', 'VEE': 'V', 'WHY': 'Y', 'ZEE': 'Z', 'ZED': 'Z' },
            init(callback) {
                if (!this.isSupported) return;
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.lang = 'en-US';
                this.recognition.interimResults = false;

                this.recognition.onresult = (event) => {
                    const last = event.results.length - 1;
                    const transcript = event.results[last][0].transcript.trim().toUpperCase();
                    console.log('語音輸入:', transcript);
                    // 嘗試從字典轉換，或直接取第一個字
                    const recognizedChar = this.charMap[transcript] || transcript.charAt(0);
                    if (recognizedChar) {
                        callback(recognizedChar);
                    }
                };
                this.recognition.onend = () => {
                    if (this.isListening) { // 如果是意外停止，就重新啟動
                        this.recognition.start();
                    }
                };
            },
            start() {
                if (this.isSupported && this.recognition && !this.isListening) {
                    this.isListening = true;
                    this.recognition.start();
                }
            },
            stop() {
                if (this.isSupported && this.recognition && this.isListening) {
                    this.isListening = false;
                    this.recognition.stop();
                }
            },
            toggle(micButton, callback) {
                if (!this.isSupported) {
                    alert('您的瀏覽器不支援語音辨識功能，建議使用 Chrome 或 Edge。');
                    return;
                }
                if (!this.recognition) this.init(callback);

                if (this.isListening) {
                    this.stop();
                    micButton.classList.remove('listening');
                    micButton.innerHTML = '🎤';
                } else {
                    this.start();
                    micButton.classList.add('listening');
                    micButton.innerHTML = '🎙️';
                }
            }
        };

        // ===================================
        // ===== 遊戲一：靜態練習 (gameStatic) =====
        // ===================================
        const gameStatic = {
            micButton: document.getElementById('gs-mic-button'),
            display: document.getElementById('gs-char-display'), message: document.getElementById('gs-message'), wordSet: ['APPLE', 'SKY', 'DREAM', 'CODE', 'HAPPY', 'SUN', 'MOON'], alphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', currentWord: '', typedIndex: 0, isGameRunning: false, isAnimating: false,
            start() { this.isGameRunning = true; this.display.innerHTML = '<span class="pulse-animation">準備好了嗎？</span>'; this.message.textContent = '請按任意鍵開始'; document.addEventListener('keydown', this.handleInitialKey, { once: true }); this.micButton.onclick = () => gameVoice.toggle(this.micButton, (char) => this.handleInput(char)); this.micButton.classList.remove('listening'); this.micButton.innerHTML = '🎤'; if (!gameVoice.isSupported) this.micButton.style.display = 'none'; else this.micButton.style.display = 'block'; },
            init() { this.getNextWord(); document.addEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); },
            end() { this.isGameRunning = false; gameVoice.stop(); document.removeEventListener('keydown', this.handleInitialKey); document.removeEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); },
            handleInitialKey: (e) => { gameStatic.init(); },
            getNextWord() { this.typedIndex = 0; let newWord; do { newWord = this.wordSet[Math.floor(Math.random() * this.wordSet.length)]; } while (newWord === this.currentWord); this.currentWord = newWord; this.display.innerHTML = ''; this.currentWord.split('').forEach(char => { const charSpan = document.createElement('span'); charSpan.textContent = char; this.display.appendChild(charSpan); }); this.message.textContent = '換你囉！'; },
            handleInput(inputChar) { if (!this.isGameRunning || this.isAnimating || !this.currentWord || inputChar.length !== 1) return; const expectedKey = this.currentWord[this.typedIndex]; if (inputChar === expectedKey) { const targetSpan = this.display.children[this.typedIndex]; this.isAnimating = true; targetSpan.classList.add('gs-correct', 'gs-shake-correct-animation'); this.typedIndex++; setTimeout(() => { targetSpan.classList.remove('gs-shake-correct-animation'); this.isAnimating = false; if (this.typedIndex === this.currentWord.length) { this.message.textContent = '太棒了！完成！'; setTimeout(() => this.getNextWord(), 1000); } }, 600); } else { const targetSpan = this.display.children[this.typedIndex]; this.isAnimating = true; targetSpan.classList.add('gs-shake-incorrect-animation'); this.message.textContent = '不對喔，是這個字母！'; setTimeout(() => { targetSpan.classList.remove('gs-shake-incorrect-animation'); this.isAnimating = false; }, 500); } }
        };

        // ===================================
        // ===== 遊戲二：打字衝刺 (gameDash) =====
        // ===================================
        const gameDash = {
            micButton: document.getElementById('gd-mic-button'),
            gameArea: document.getElementById('gd-game-area'), scoreDisplay: document.getElementById('gd-score-display'), livesDisplay: document.getElementById('gd-lives-display'), levelDisplay: document.getElementById('gd-level-display'), countdownDisplay: document.getElementById('gd-countdown-display'), gameOverScreen: document.getElementById('gd-game-over-screen'), restartButton: document.getElementById('gd-restart-button'), finalScoreDisplay: document.getElementById('gd-final-score'), ALPHABET: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', INITIAL_LIVES: 5, HITS_PER_LEVEL: 10, LEVELS: [ { speed: 0.8, spawn: 1800 }, { speed: 1.0, spawn: 1600 }, { speed: 1.2, spawn: 1400 }, { speed: 1.5, spawn: 1200 }, { speed: 1.8, spawn: 1000 }, { speed: 2.1, spawn: 900 }, { speed: 2.4, spawn: 800 }, { speed: 2.7, spawn: 700 }, { speed: 3.0, spawn: 600 }, { speed: 3.4, spawn: 500 }, ], score: 0, lives: 0, lettersOnScreen: [], gameLoopId: null, lastSpawnTime: 0, isGameRunning: false, currentLevel: 1, hitsInLevel: 0, fallSpeed: 1, spawnRate: 1500,
            start() { this.isGameRunning = true; this.score = 0; this.lives = this.INITIAL_LIVES; this.currentLevel = 1; this.hitsInLevel = 0; this.lettersOnScreen.forEach(letter => letter.element.remove()); this.lettersOnScreen = []; this.updateLevelSettings(); this.updateUI(); this.gameOverScreen.classList.add('hidden'); document.addEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); this.restartButton.onclick = () => this.start(); this.micButton.onclick = () => gameVoice.toggle(this.micButton, (char) => this.handleInput(char)); this.micButton.classList.remove('listening'); this.micButton.innerHTML = '🎤'; if (!gameVoice.isSupported) this.micButton.style.display = 'none'; else this.micButton.style.display = 'block'; this.gameLoop(0); },
            end() { this.isGameRunning = false; gameVoice.stop(); if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId); document.removeEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); },
            updateLevelSettings() { const levelConfig = this.LEVELS[this.currentLevel - 1]; this.fallSpeed = levelConfig.speed; this.spawnRate = levelConfig.spawn; },
            updateUI() { this.scoreDisplay.textContent = this.score; this.livesDisplay.textContent = '❤️'.repeat(this.lives); this.levelDisplay.textContent = this.currentLevel; this.countdownDisplay.textContent = this.HITS_PER_LEVEL - this.hitsInLevel; },
            levelUp() { if (this.currentLevel < this.LEVELS.length) { this.currentLevel++; } this.hitsInLevel = 0; this.updateLevelSettings(); },
            gameLoop(timestamp) { if (!this.isGameRunning) return; if (timestamp - this.lastSpawnTime > this.spawnRate) { this.lastSpawnTime = timestamp; this.spawnLetter(); } this.moveLetters(); this.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this)); },
            spawnLetter() { const char = this.ALPHABET[Math.floor(Math.random() * this.ALPHABET.length)]; const letterElement = document.createElement('div'); letterElement.className = 'letter'; letterElement.textContent = char; const xPosition = Math.random() * (this.gameArea.clientWidth - 45); letterElement.style.left = `${xPosition}px`; letterElement.style.top = `-45px`; this.gameArea.appendChild(letterElement); this.lettersOnScreen.push({ element: letterElement, character: char, y: -45 }); },
            moveLetters() { const gameAreaHeight = this.gameArea.clientHeight; for (let i = this.lettersOnScreen.length - 1; i >= 0; i--) { const letter = this.lettersOnScreen[i]; letter.y += this.fallSpeed; letter.element.style.top = `${letter.y}px`; if (letter.y > gameAreaHeight) { letter.element.remove(); this.lettersOnScreen.splice(i, 1); this.loseLife(); } } },
            handleInput(inputChar) { if (!this.isGameRunning || inputChar.length !== 1) return; for (let i = this.lettersOnScreen.length - 1; i >= 0; i--) { if (this.lettersOnScreen[i].character === inputChar) { const letter = this.lettersOnScreen[i]; this.score++; this.hitsInLevel++; if(this.hitsInLevel >= this.HITS_PER_LEVEL) { this.levelUp(); } letter.element.classList.add('popped'); setTimeout(() => letter.element.remove(), 200); this.lettersOnScreen.splice(i, 1); this.updateUI(); return; } } },
            loseLife() { this.lives--; gameWrapper.classList.add('screen-shake-animation'); setTimeout(() => { gameWrapper.classList.remove('screen-shake-animation'); }, 400); if (this.lives <= 0) { this.end(); this.finalScoreDisplay.textContent = this.score; this.gameOverScreen.classList.remove('hidden'); } this.updateUI(); },
        };
        
        // ===================================
        // ===== 遊戲三：打怪物 (gameMonster) =====
        // ===================================
        const gameMonster = {
            micButton: document.getElementById('gm-mic-button'),
            gameArea: document.getElementById('gm-game-area'), levelDisplay: document.getElementById('gm-level-display'), defeatedDisplay: document.getElementById('gm-defeated-display'), gameOverScreen: document.getElementById('gm-game-over-screen'), restartButton: document.getElementById('gm-restart-button'), finalLevelDisplay: document.getElementById('gm-final-level'), 
            ALPHABET: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), MONSTERS_PER_BOSS: 10, SPAWN_EDGE_BUFFER: 80,
            LEVELS: [ { count: 1, interval: 3000, growth: 0.05 }, { count: 2, interval: 2800, growth: 0.06 }, { count: 2, interval: 2500, growth: 0.07 }, { count: 3, interval: 2300, growth: 0.08 }, { count: 3, interval: 2000, growth: 0.10 }, { count: 4, interval: 1800, growth: 0.12 }, { count: 4, interval: 1600, growth: 0.14 }, { count: 5, interval: 1500, growth: 0.16 }, { count: 5, interval: 1400, growth: 0.18 }, { count: 6, interval: 1300, growth: 0.20 }, ],
            DESIGNS: {
                ghost:   { emoji: '👻', size: 60 }, pumpkin: { emoji: '🎃', size: 60 }, lion:    { emoji: '🦁', size: 60 },
                tiger:   { emoji: '🐯', size: 60 }, alien:   { emoji: '👾', size: 60 }, robot:   { emoji: '🤖', size: 60 }
            },
            BOSS_DESIGNS: [
                {
                    name: '火焰魔龍', containerSize: { width: 350, height: 280 }, growth: 0.06,
                    parts: [
                        { id: 'head', emoji: '🐲', size: 120, position: { top: '0px', left: '115px' }, isMain: true },
                        { id: 'l_wing', emoji: '🐉', size: 80, position: { top: '50px', left: '45px' } },
                        { id: 'r_wing', emoji: '🐉', size: 80, position: { top: '50px', left: '225px' } },
                        { id: 'tail', emoji: '🔥', size: 60, position: { top: '200px', left: '145px' }, isWeakPoint: true, growthFactor: 1.5 }
                    ]
                },
                {
                    name: '巨大機器人', containerSize: { width: 300, height: 300 }, growth: 0.08,
                    parts: [
                        { id: 'head', emoji: '🤖', size: 100, position: { top: '0px', left: '100px' }, isMain: true },
                        { id: 'l_arm', emoji: '🦾', size: 120, position: { top: '80px', left: '-20px' }, growthFactor: 1.2, isWeakPoint: true },
                        { id: 'r_arm', emoji: '�', size: 120, position: { top: '80px', left: '200px' }, growthFactor: 1.2 },
                        { id: 'l_leg', emoji: '🦿', size: 100, position: { top: '180px', left: '60px' } },
                        { id: 'r_leg', emoji: '🦿', size: 100, position: { top: '180px', left: '140px' } }
                    ]
                },
                {
                    name: '宇宙章魚', containerSize: { width: 320, height: 320 }, growth: 0.07,
                    parts: [
                        { id: 'body', emoji: '🐙', size: 130, position: { top: '80px', left: '95px' }, isMain: true },
                        { id: 't1', emoji: '🐍', size: 70, position: { top: '20px', left: '50px' }, cssClass: 'tentacle' },
                        { id: 't2', emoji: '🐍', size: 70, position: { top: '20px', left: '200px' }, cssClass: 'tentacle', isWeakPoint: true },
                        { id: 't3', emoji: '🐍', size: 70, position: { top: '180px', left: '50px' }, cssClass: 'tentacle' },
                        { id: 't4', emoji: '🐍', size: 70, position: { top: '180px', left: '200px' }, cssClass: 'tentacle' },
                    ]
                }
            ],
            isGameRunning: false, gameLoopId: null, lastSpawnTime: 0, currentLevel: 1, monstersDefeated: 0, monstersOnScreen: [], activeChars: [], isBossActive: false,
            start() { this.isGameRunning = true; this.currentLevel = 1; this.monstersDefeated = 0; this.isBossActive = false; this.gameArea.innerHTML = ''; this.monstersOnScreen = []; this.activeChars = []; this.updateUI(); this.gameOverScreen.classList.add('hidden'); document.addEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); this.restartButton.onclick = () => this.start(); this.micButton.onclick = () => gameVoice.toggle(this.micButton, (char) => this.handleInput(char)); this.micButton.classList.remove('listening'); this.micButton.innerHTML = '🎤'; if (!gameVoice.isSupported) this.micButton.style.display = 'none'; else this.micButton.style.display = 'block'; this.gameLoop(0); },
            end() { this.isGameRunning = false; gameVoice.stop(); if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId); document.removeEventListener('keydown', (e) => this.handleInput(e.key.toUpperCase())); },
            updateUI() { this.levelDisplay.textContent = this.currentLevel; this.defeatedDisplay.textContent = this.monstersDefeated; },
            gameLoop(timestamp) {
                if (!this.isGameRunning) return;
                const config = this.LEVELS[this.currentLevel - 1];
                if (!this.isBossActive && this.monstersOnScreen.length < config.count && timestamp - this.lastSpawnTime > config.interval) {
                    this.lastSpawnTime = timestamp;
                    this.spawnMonster();
                }
                this.monstersOnScreen.forEach(monster => {
                    if (monster.isDefeated) return;
                    let mainElementForCollision = monster.el;
                    if (monster.isBoss) {
                        const boss = monster;
                        const bossGrowth = boss.design.growth;
                        mainElementForCollision = boss.mainPart.el;
                        boss.parts.forEach(part => {
                            if(part.isDefeated) return;
                            const partGrowth = bossGrowth * (part.info.growthFactor || 1);
                            part.size += partGrowth;
                            part.el.style.width = `${part.size}px`;
                            part.el.style.height = `${part.size}px`;
                            part.el.querySelector('.monster-graphic').style.fontSize = `${part.size * 0.8}px`;
                        });
                    } else {
                        monster.size += config.growth;
                        monster.el.style.width = `${monster.size}px`;
                        monster.el.style.height = `${monster.size}px`;
                        monster.el.querySelector('.monster-graphic').style.fontSize = `${monster.size * 0.8}px`;
                    }
                    const rect = mainElementForCollision.getBoundingClientRect();
                    const parentRect = this.gameArea.getBoundingClientRect();
                    if (rect.left < parentRect.left || rect.right > parentRect.right || rect.top < parentRect.top || rect.bottom > parentRect.bottom) {
                        this.gameOver();
                    }
                });
                this.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
            },
            spawnMonster() {
                const designKeys = Object.keys(this.DESIGNS);
                const randomDesignKey = designKeys[Math.floor(Math.random() * designKeys.length)];
                const design = this.DESIGNS[randomDesignKey];
                let char;
                do { char = this.ALPHABET[Math.floor(Math.random() * this.ALPHABET.length)]; } while (this.activeChars.includes(char));
                const monsterEl = document.createElement('div');
                monsterEl.className = 'monster';
                monsterEl.innerHTML = `<div class="monster-graphic">${design.emoji}</div><div class="monster-char">${char}</div>`;
                const size = design.size;
                monsterEl.style.width = `${size}px`;
                monsterEl.style.height = `${size}px`;
                monsterEl.querySelector('.monster-graphic').style.fontSize = `${size * 0.8}px`;
                const buffer = this.SPAWN_EDGE_BUFFER;
                const x = buffer + Math.random() * (this.gameArea.clientWidth - size - buffer * 2);
                const y = buffer + Math.random() * (this.gameArea.clientHeight - size - buffer * 2);
                monsterEl.style.left = `${x}px`;
                monsterEl.style.top = `${y}px`;
                const monster = { el: monsterEl, char: char, size: size, isDefeated: false };
                this.monstersOnScreen.push(monster);
                this.activeChars.push(char);
                this.gameArea.appendChild(monsterEl);
            },
            spawnBoss() {
                this.isBossActive = true;
                this.gameArea.innerHTML = '';
                this.monstersOnScreen = [];
                this.activeChars = [];
                const bossDesign = this.BOSS_DESIGNS[Math.floor(Math.random() * this.BOSS_DESIGNS.length)];
                const bossContainer = document.createElement('div');
                bossContainer.className = 'monster';
                bossContainer.style.width = `${bossDesign.containerSize.width}px`;
                bossContainer.style.height = `${bossDesign.containerSize.height}px`;
                const bossParts = [];
                let mainPart = null;
                let weakPoint = null;
                bossDesign.parts.forEach(partInfo => {
                    let char;
                    do { char = this.ALPHABET[Math.floor(Math.random() * this.ALPHABET.length)]; } while (this.activeChars.includes(char));
                    this.activeChars.push(char);
                    const partEl = document.createElement('div');
                    partEl.className = 'boss-part';
                    if (partInfo.cssClass) partEl.classList.add(partInfo.cssClass);
                    if (partInfo.isWeakPoint) partEl.classList.add('weak-point');
                    partEl.innerHTML = `<div class="monster-graphic" style="font-size: ${partInfo.size * 0.8}px">${partInfo.emoji}</div><div class="monster-char">${char}</div>`;
                    partEl.style.top = partInfo.position.top;
                    partEl.style.left = partInfo.position.left;
                    partEl.style.width = `${partInfo.size}px`;
                    partEl.style.height = `${partInfo.size}px`;
                    bossContainer.appendChild(partEl);
                    const partObject = { el: partEl, char: char, info: partInfo, size: partInfo.size, isDefeated: false };
                    bossParts.push(partObject);
                    if (partInfo.isMain) mainPart = partObject;
                    if (partInfo.isWeakPoint) weakPoint = partObject;
                });
                const size = bossDesign.containerSize.width;
                bossContainer.style.left = `${(this.gameArea.clientWidth - size) / 2}px`;
                bossContainer.style.top = `${(this.gameArea.clientHeight - bossDesign.containerSize.height) / 2}px`;
                const boss = { el: bossContainer, isBoss: true, parts: bossParts, mainPart: mainPart, weakPoint: weakPoint, design: bossDesign, size: size, isDefeated: false };
                this.monstersOnScreen.push(boss);
                this.gameArea.appendChild(bossContainer);
            },
            handleInput(inputChar) {
                if (!this.isGameRunning || inputChar.length !== 1) return;
                if (this.isBossActive) {
                    const boss = this.monstersOnScreen[0];
                    if (!boss || boss.isDefeated) return;
                    const partToHit = boss.parts.find(p => p.char === inputChar && !p.isDefeated);
                    if (partToHit) {
                        partToHit.el.classList.add('monster-hit');
                        partToHit.isDefeated = true; 
                        if (partToHit.info.isMain) {
                            boss.isDefeated = true;
                            boss.el.classList.add('monster-explode');
                            setTimeout(() => {
                                this.isBossActive = false;
                                if(this.currentLevel < this.LEVELS.length) this.currentLevel++;
                                this.monstersDefeated++;
                                this.updateUI();
                                this.gameArea.innerHTML = '';
                                this.monstersOnScreen = [];
                            }, 800);
                        } else {
                            setTimeout(() => {
                                partToHit.el.classList.add('monster-explode');
                            }, 300);
                            const weakPointIsActive = boss.weakPoint && !boss.weakPoint.isDefeated;
                            if (weakPointIsActive && !partToHit.info.isWeakPoint) {
                                setTimeout(() => {
                                    partToHit.isDefeated = false;
                                    partToHit.el.classList.remove('monster-explode', 'monster-hit');
                                }, 3000);
                            }
                        }
                    }
                    return; 
                }
                const monsterIndex = this.monstersOnScreen.findIndex(m => m.char === inputChar);
                if (monsterIndex > -1) {
                    const monster = this.monstersOnScreen[monsterIndex];
                    monster.isDefeated = true;
                    monster.el.classList.add('monster-hit');
                    setTimeout(() => {
                        monster.el.classList.add('monster-explode');
                        setTimeout(() => monster.el.remove(), 300);
                    }, 300);
                    this.monstersOnScreen.splice(monsterIndex, 1);
                    this.activeChars.splice(this.activeChars.indexOf(char), 1);
                    this.monstersDefeated++;
                    this.updateUI();
                    if (this.monstersDefeated > 0 && this.monstersDefeated % this.MONSTERS_PER_BOSS === 0) {
                        this.spawnBoss();
                    }
                }
            },
            gameOver() { if (!this.isGameRunning) return; this.end(); gameWrapper.classList.add('screen-shake-animation'); setTimeout(() => gameWrapper.classList.remove('screen-shake-animation'), 400); this.finalLevelDisplay.textContent = this.currentLevel; this.gameOverScreen.classList.remove('hidden'); }
        };
        
        const games = {
            static: gameStatic,
            dash: gameDash,
            monster: gameMonster
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">